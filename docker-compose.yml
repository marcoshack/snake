services:
  snake:
    image: ghcr.io/marcoshack/snake:latest
    container_name: snake
    environment:
      # Force Python to run in unbuffered mode for immediate log output
      PYTHONUNBUFFERED: 1

      # Anthropic API key for accessing Claude models
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}

      # OpenSearch connection for fetching Rust server logs
      OPENSEARCH_HOST: ${OPENSEARCH_HOST}
      OPENSEARCH_PORT: ${OPENSEARCH_PORT:-9200}
      OPENSEARCH_USER: ${OPENSEARCH_USER}
      OPENSEARCH_PASSWORD: ${OPENSEARCH_PASSWORD}
      OPENSEARCH_INDEX: ${OPENSEARCH_INDEX}
      OPENSEARCH_RESULT_SIZE: ${OPENSEARCH_RESULT_SIZE:-10000}

      # Discord webhook for posting admin alerts
      DISCORD_RUST_ADMIN_WEBHOOK: ${DISCORD_RUST_ADMIN_WEBHOOK}

      # Chat API endpoint for sending messages to Rust server Global chat
      SNAKE_CHAT_API_ENDPOINT: ${SNAKE_CHAT_API_ENDPOINT}

      # Override paths to container paths (agent reads these inside container)
      REPORT_OUTPUT_DIR: /app/reports
      LOG_DIR: /app/logs

      # Agents to run with per-agent frequency (name:frequency pairs)
      SNAKE_AGENTS: ${SNAKE_AGENTS:-operational-report:24h}

      # Path to agent definitions inside the container
      SNAKE_AGENTS_DIR: /app/agents

      # Path to session storage inside the container
      SNAKE_SESSIONS_DIR: /app/sessions

      # Max conversation messages to retain per agent (sliding window)
      SNAKE_CONTEXT_WINDOW_SIZE: ${SNAKE_CONTEXT_WINDOW_SIZE:-10}

      # Webhook server port (internal only, not exposed to host)
      SNAKE_WEBHOOK_PORT: ${SNAKE_WEBHOOK_PORT:-8000}

    volumes:
      # Mount host directories (from .env) to container paths
      - ${REPORT_OUTPUT_DIR:-./reports}:/app/reports
      - ${LOG_DIR:-./logs}:/app/logs
      # Mount agents directory for hot-reload of agent definitions
      - ${SNAKE_AGENTS_DIR:-./agents}:/app/agents
      # Mount sessions directory for persistent conversation history
      - ${SNAKE_SESSIONS_DIR:-./sessions}:/app/sessions

    restart: unless-stopped
    ports:
      # Expose webhook server port to host
      - "${SNAKE_WEBHOOK_PORT:-8000}:${SNAKE_WEBHOOK_PORT:-8000}"
